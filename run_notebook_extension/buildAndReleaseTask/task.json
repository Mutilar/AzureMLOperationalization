{
    "id": "9e02bec7-16e1-4fb4-b56f-cc70b56f078e",
    "name": "RunNotebookTest",
    "friendlyName": "Agentlessly Run Notebook",
    "description": "Sends a message to Azure Service Bus to trigger a Run Notebook job",
    "category": "Utility",
    "helpUrl": "https://docs.microsoft.com/azure/devops/pipelines/tasks/utility/publish-to-azure-service-bus",
    "helpMarkDown": "[Learn more about this task](https://go.microsoft.com/fwlink/?linkid=870237)",
    "visibility": [
        "Build",
        "Release"
    ],
    "runsOn": [
        "Server"
    ],
    "author": "Microsoft Corporation",
    "version": {
        "Major": 1,
        "Minor": 0,
        "Patch": 15
    },
    "groups": [
        {
            "name": "advancedProperties",
            "displayName": "Advanced",
            "isExpanded": false
        }
    ],
    "inputs": [
        {
            "name": "connectedServiceName",
            "aliases": [
                "azureSubscription"
            ],
            "type": "connectedService:AzureServiceBus",
            "label": "Azure Service Bus service connection",
            "defaultValue": "",
            "required": true,
            "helpMarkDown": "Select an Azure Service Bus service connection."
        },
        {
            "name": "messageBody",
            "type": "multiLine",
            "label": "Message body",
            "required": false,
            "defaultValue": "",
            "helpMarkDown": "Enter the json messageBody.",
            "properties": {
                "resizable": "true",
                "rows": "10",
                "maxLength": "5000",
                "editorExtension": "ms.vss-services-azure.azure-servicebus-message-grid"
            }
        },
        {
            "name": "sessionId",
            "type": "string",
            "label": "Session Id",
            "required": false,
            "defaultValue": "",
            "helpMarkDown": "Session id with which message is published. For session based queues, publishing fails if value not specified. For Non Session Based Queues, it will not matter.",
            "groupName": "advancedProperties"
        },
        {
            "name": "signPayload",
            "type": "boolean",
            "label": "Sign the Message",
            "defaultValue": "false",
            "required": true,
            "helpMarkDown": "If this is set to true, message will be signed provided a private certificate.",
            "groupName": "advancedProperties"
        },
        {
            "name": "certificateString",
            "type": "string",
            "label": "Certificate Variable",
            "required": true,
            "defaultValue": "",
            "helpMarkDown": "Specify the secret variable that contains the certificate content.  This can also be a certificate stored in an Azure key vault that is [linked](https://docs.microsoft.com/en-us/vsts/pipelines/library/variable-groups?view=vsts#link-secrets-from-an-azure-key-vault-as-variables) to a Variable Group used by this release pipeline.",
            "visibleRule": "signPayload = true",
            "groupName": "advancedProperties"
        },
        {
            "name": "signatureKey",
            "type": "string",
            "label": "Signature Property Key",
            "required": false,
            "defaultValue": "signature",
            "helpMarkDown": "Key where you want signature to be in Message Properties. If left Empty, default is 'signature' in message properties",
            "visibleRule": "signPayload = true",
            "groupName": "advancedProperties"
        },
        {
            "name": "waitForCompletion",
            "type": "boolean",
            "label": "Wait for task completion",
            "defaultValue": "false",
            "required": true,
            "helpMarkDown": "If this is true, this task will wait for TaskCompleted event for the specified task timeout."
        }
    ],
    "instanceNameFormat": "Publish to Azure Service Bus",
    "execution": {
        "ServiceBus": {
            "events": {
                "taskCompleted": {
                    "enabled": "$(waitForCompletion)"
                }
            },
            "execute": {
                "endpointId": "$(connectedServiceName)",
                "connectionString": "$(endpoint.serviceBusConnectionString)",
                "serviceBusQueueName": "$(endpoint.serviceBusQueueName)",
                "messageBody": "$(messageBody)",
                "sessionId": "$(sessionId)",
                "certificateString": "{{#notEquals signPayload 'false' 1}}{{#notEquals endpoint.signPayload 'false' 1}}$(certificateString){{/notEquals}}{{else}}{{/notEquals}}",
                "signaturePropertyKey": "$(signatureKey)",
                "messageProperties": {
                    "job": "!START",
                    "auth_token": "$(system.AccessToken)",
                    "build_id": "$(Build.BuildId)",
                    "run_config": {
                        "repo": "$(gh.repo)",
                        "version": "$(rp.version)",
                        "notebooks": "$(rp.notebooks)",
                        "conda_file": "$(rp.condaFile)",
                        "compute_target": "$(ex.compute)",
                        "base_image": "$(ex.image)"
                    },
                    "azure_resources": {
                        "organization": "$(do.organization)",
                        "project": "$(do.project)",
                        "run_id": "default_run_id",
                        "service_principal": {
                            "username": "$(sp.client)",
                            "tenant": "$(sp.tenant)",
                            "password": "$(sp.password)"
                        },
                        "workspace": {
                            "name": "$(ws.name)",
                            "subscription_id": "$(ws.subscription)",
                            "resource_group": "$(ws.resourceGroup)"
                        }
                    },
                    "wrap_up": {
                        "queue": {
                            "connection_string": "$(sb.connection)",
                            "name": "$(sb.name)"
                        },
                        "call_back": {
                            "error_message": "default_error_message",
                            "plan_url": "$(system.CollectionUri)",
                            "project_id": "$(system.TeamProjectId)", 
                            "hub_name": "$(system.HostType)",
                            "plan_id": "$(system.PlanId)",
                            "job_id": "$(system.JobId)",
                            "timeline_id": "$(system.TimelineId)",
                            "task_id": "$(system.TaskInstanceId)"
                        }
                    }
                }
            }
        }
    }
}